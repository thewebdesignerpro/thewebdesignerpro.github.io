if("undefined"==typeof MIDI)var MIDI={};"undefined"==typeof MIDI.Player&&(MIDI.Player={}),function(){"use strict";var e=MIDI.Player;e.callback=void 0,e.currentTime=0,e.endTime=0,e.restart=0,e.playing=!1,e.timeWarp=1,e.start=e.resume=function(){e.currentTime<-1&&(e.currentTime=-1),s(e.currentTime)},e.pause=function(){var n=e.restart;f(),e.restart=n,notemsg=0},e.stop=function(){f(),e.restart=0,e.currentTime=0},e.addListener=function(e){o=e},e.removeListener=function(){o=void 0},e.clearAnimation=function(){e.interval&&window.clearInterval(e.interval)},e.setAnimation=function(n){var t="function"==typeof n?n:n.callback,r=n.delay||100,a=0,o=0,c=0;e.clearAnimation(),e.interval=window.setInterval(function(){if(0!==e.endTime){e.playing?(a=c==e.currentTime?o-(new Date).getTime():0,a=0===e.currentTime?0:e.currentTime-a,c!=e.currentTime&&(o=(new Date).getTime(),c=e.currentTime),planim=!0):(a=e.currentTime,planim=!1);var n=e.endTime,r=a/1e3,u=r/60,l=r-60*u,s=60*u+l,f=n/1e3;return-1>f-s?($(".player-stop").trigger("click",function(e){e.preventDefault()}),notemsg=0,void(planim=!1)):void t({now:s,end:f,events:i})}},r)};var n=function(){e.replayer=new Replayer(MidiFile(e.currentData),e.timeWarp),e.data=e.replayer.getData(),e.endTime=l()};e.loadFile=function(t,r){if(e.stop(),-1!==t.indexOf("base64,")){var a=window.atob(t.split(",")[1]);return e.currentData=a,n(),void(r&&r(a))}var i=new XMLHttpRequest;i.open("GET",t),i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===this.readyState&&200===this.status){for(var t=this.responseText||"",a=[],i=t.length,o=String.fromCharCode,c=0;i>c;c++)a[c]=o(255&t.charCodeAt(c));var u=window.atob(a.join(""));e.currentData=u,n(),r&&r(u)}},i.send()};var t,r=[],a=0,i={},o=void 0,c=function(n,r,a,c,u,l){var f=window.setInterval(function(){window.clearInterval(f);var c={channel:n,note:r,now:a,end:e.endTime,message:u,velocity:l};128===u?delete i[r]:i[r]=c,o&&o(c),e.currentTime=a,e.currentTime===t&&t<e.endTime&&s(t,!0)},a-c);return f},u=function(){return"WebAudioAPI"===MIDI.lang?MIDI.Player.ctx:(e.ctx||(e.ctx={currentTime:0}),e.ctx)},l=function(){for(var n=e.data,t=n.length,r=.5,a=0;t>a;a++)r+=n[a][1];return r},s=function(n,i){if(e.replayer){i||("undefined"==typeof n&&(n=e.restart),e.playing&&f(),e.playing=!0,e.data=e.replayer.getData(),e.endTime=l());var o,s=0,d=0,m=e.data,v=u(),p=m.length;t=.5,a=v.currentTime;for(var I=0;p>I&&100>d;I++)if(t+=m[I][1],n>=t)s=t;else{n=t-s;var y=m[I][0].event;if("channel"===y.type){var T=y.channel;switch(y.subtype){case"noteOn":if(MIDI.channels[T].mute)break;o=y.noteNumber-(e.MIDIOffset||0),r.push({event:y,source:MIDI.noteOn(T,y.noteNumber,y.velocity,n/1e3+v.currentTime),interval:c(T,o,t,s,144,y.velocity)}),d++;break;case"noteOff":if(MIDI.channels[T].mute)break;o=y.noteNumber-(e.MIDIOffset||0),r.push({event:y,source:MIDI.noteOff(T,y.noteNumber,n/1e3+v.currentTime),interval:c(T,o,t,s-10,128)})}}}}},f=function(){var n=u();for(e.playing=!1,e.restart+=1e3*(n.currentTime-a);r.length;){var t=r.pop();if(window.clearInterval(t.interval),t.source)if("number"==typeof t.source)window.clearTimeout(t.source);else{var c=t.source;c.disconnect(0)}}for(var l in i){var t=i[l];144===i[l].message&&o&&o({channel:t.channel,note:t.note,now:t.now,end:t.end,message:128,velocity:t.velocity})}i={}}}();