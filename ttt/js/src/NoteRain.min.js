(function(){var e,t=function(e,t){return function(){return e.apply(t,arguments)}};e=function(){function e(e){this.pianoDesign=e,this.update=t(this.update,this),this.model=new THREE.Object3D}return e.prototype.lengthScale=.001,e.prototype.setMidiData=function(e,t){var n;return this.clear(),n=this._getNoteInfos(e),this._buildNoteMeshes(n,t)},e.prototype.clear=function(){var e,t,n,o,r;for(o=this.model.children.slice(0),r=[],t=0,n=o.length;n>t;t++)e=o[t],r.push(this.model.remove(e));return r},e.prototype._getNoteInfos=function(e){var t,n,o,r,i,s,u,l,a,h,c,p,f,y;for(n=0,s=[],l=[],c=0,p=e.length;p>c;c++)f=e[c],y=f[0],r=y.event,i=f[1],n+=i,h=r.subtype,u=r.noteNumber,t=r.channel,9!==t&&("noteOn"===h?l[u]=n:"noteOff"===h&&(a=l[u],o=n-a,s.push({noteNumber:u,startTime:a,duration:o})));return s},e.prototype._buildNoteMeshes=function(e,t){var n,o,r,i,s,u,l,a,h,c,p,f,y,d,g,m=this;for(g=this.pianoDesign,s=g.blackKeyWidth,i=g.blackKeyHeight,a=g.keyInfo,o=g.KeyType,h=g.noteToColor,n=o.Black,p=function(e,t){var n,o,r,i,s;for(n=[],r=Math.ceil(e.length/t),i=0,o=s=0;r>=0?r>s:s>r;o=r>=0?++s:--s)n[o]=e.slice(i,i+t),i+=t;return n},c=function(e){return setTimeout(function(){return e(null)},0)},f=[],r=100,l=p(e,r),y=0,d=l.length;d>y;y++)u=l[y],f.push(c),f.push(function(e){return function(t){var o,r,u,l,c,p,f,y,d,g,v,T,b,E;for(b=0,E=e.length;E>b;b++)f=e[b],y=f.noteNumber,d=f.startTime,r=f.duration,l=r*m.lengthScale,g=a[y].keyCenterPosX,v=d*m.lengthScale+l/2-2,T=.04,a[y].keyType===n&&(v+=i/2),o=h(y),u=new THREE.CylinderGeometry(.4*s,.4*s,l,3,1,!0),c=new THREE.MeshPhongMaterial({color:o,emissive:o,opacity:.7,transparent:!0,fog:!0,shininess:1}),p=new THREE.Mesh(u,c),p.position.set(g,v,T),m.model.add(p);return t(null)}}(u));return async.series(f,function(){return"function"==typeof t?t():void 0})},e.prototype.update=function(e){return this.model.position.y=-e*this.lengthScale},e}(),this.NoteRain=e}).call(this);