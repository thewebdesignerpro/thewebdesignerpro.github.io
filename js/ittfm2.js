/**
 * author Armstrong "Army" Chiu
 * URL: https://thewebdesignerpro.com/     
 */
 
import*as e from"three";import t from"three/addons/capabilities/WebGL.js";import{OBJLoader as n}from"three/addons/loaders/OBJLoader.js";import{FBXLoader as i}from"three/addons/loaders/FBXLoader.js";import o from"three/addons/libs/tween.module.js";let idleTO=120,florY=-100,camera,scene,renderer,clock,grup5,grup6,isMobil=!1,mouseX=0,mouseY=-50,mixer,ui={},win={},x={};if(!1===t.isWebGLAvailable()){let r=t.getWebGLErrorMessage();document.body.appendChild(r)}else window.addEventListener?window.addEventListener("load",init,!1):window.attachEvent?window.attachEvent("onload",init):window.onload=init;function init(){ui.kontainer=document.getElementById("kontainer");let t=document.createElement("div");if(t.setAttribute("id","dummy"),document.body.appendChild(t),(isMobil="9000px"!=window.getComputedStyle(t,null).getPropertyValue("left"))&&(document.addEventListener("gesturechange",function(e){e.preventDefault()},!1),ui.kontainer.addEventListener("gesturechange",function(e){e.preventDefault()},!1)),t.parentNode.removeChild(t),win.width=window.innerWidth,win.height=window.innerHeight,document.body.style.width=win.width+"px",document.body.style.height=win.height+"px",ui.kontainer.style.width=win.width+"px",ui.kontainer.style.height=win.height+"px",ui.kontainer.style.opacity=0,ui.kontainer.style.backgroundColor="#2e3032",(renderer=new e.WebGLRenderer({antialias:!0,alpha:!1})).setPixelRatio(window.devicePixelRatio),renderer.setSize(win.width,win.height),renderer.setClearColor(3026994,1),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=e.PCFSoftShadowMap,renderer.sortObjects=!1,ui.kontainer.appendChild(renderer.domElement),!1===renderer.capabilities.isWebGL2&&!renderer.extensions.get("OES_texture_float"))throw alert("OES_texture_float not supported"),"missing webgl extension";if(!1===renderer.capabilities.isWebGL2&&!renderer.extensions.get("OES_texture_float_linear"))throw alert("OES_texture_float_linear not supported"),"missing webgl extension";(scene=new e.Scene).fog=new e.FogExp2(3026994,.0037),(camera=new e.PerspectiveCamera(45,win.width/win.height,1,1e4)).position.set(9,-25,1144),scene.add(camera),scene.add(new e.AmbientLight(657930)),x.spotLight=new e.SpotLight(16777215,68e4,450,Math.PI/4,1),x.spotLight.position.set(0,300,1060),x.spotLight.castShadow=!0,x.spotLight.shadow.camera.near=100,x.spotLight.shadow.camera.far=500,x.spotLight.shadow.camera.fov=30,scene.add(x.spotLight),onWindowResize(),window.removeEventListener("load",init,!1),window.addEventListener("resize",onWindowResize,!1),(clock=new e.Clock).autoStart=!1,grup5=new e.Group,grup6=new e.Group,addGround(),addTrees(),addFog(),animFBX(),win.mouse=new e.Vector2,win.entro=!0,win.idleTimer=0,win.fokus=!0,win.pointer=new e.Vector2}function entro(){ui.tempDiv=document.createElement("div"),ui.tempDiv.setAttribute("id","noAud"),ui.tempDiv.innerHTML="ENTER",ui.tempDiv.style.display="block",ui.tempDiv.style.position="absolute",ui.tempDiv.style.margin="auto",ui.tempDiv.style.top="40%",ui.tempDiv.style.bottom=ui.tempDiv.style.left=ui.tempDiv.style.right="0",ui.tempDiv.style.width="160px",ui.tempDiv.style.height="48px",ui.tempDiv.style.lineHeight="48px",ui.tempDiv.style.fontFamily="sans-serif",ui.tempDiv.style.fontSize="24px",ui.tempDiv.style.textAlign="center",ui.tempDiv.style.color="rgba(255, 255, 255, 0.5)",ui.tempDiv.style.backgroundColor="rgba(255, 255, 255, 0.15)",ui.tempDiv.style.border="2px solid rgba(255, 255, 255, 0.5)",ui.tempDiv.style.cursor="pointer",ui.kontainer.appendChild(ui.tempDiv),isMobil||document.addEventListener("keyup",clickTap,!1)}function addGround(){x.ground=[];let t=new e.PlaneGeometry(1200,602),n=new e.MeshStandardMaterial({color:10592673,roughness:.35,metalness:.3});for(let i=0;i<2;i++)x.ground[i]=new e.Mesh(t,n),x.ground[i].position.set(0,-100,301),x.ground[i].rotation.x=-.5*Math.PI,x.ground[i].receiveShadow=!0,1==i?grup5.add(x.ground[i]):grup6.add(x.ground[i]);var o=new e.TextureLoader,r=new e.TextureLoader;o.load("img/ground24c2.jpg",function(t){t.wrapS=t.wrapT=e.RepeatWrapping,t.repeat.set(6,3);for(let n=0;n<2;n++)x.ground[n].material.map=t,x.ground[n].material.needsUpdate=!0}),r.load("img/ground24b2.jpg",function(t){t.wrapS=t.wrapT=e.RepeatWrapping,t.repeat.set(6,3);for(let n=0;n<2;n++)x.ground[n].material.bumpScale=1.5,x.ground[n].material.bumpMap=t,x.ground[n].material.needsUpdate=!0}),grup5.position.z=600,scene.add(grup5),scene.add(grup6)}let randomizeMatrix=function(){let t=new e.Vector3,n=new e.Euler,i=new e.Quaternion,o=new e.Vector3;return function(e){let r=1140*Math.random()-570;r>-33&&r<33&&(r=35*(.5>Math.random()?-1:1)),t.x=r,t.y=15*Math.random()-15,t.z=580*Math.random()-290,n.x=-(Math.PI/2),n.y=(.02*Math.random()-.01)*Math.PI,n.z=2*Math.random()*Math.PI,i.setFromEuler(n),o.x=o.y=o.z=42-7*Math.random(),e.compose(t,i,o)}}();function addTrees(){x.treez=[],x.branchez=[];let t=[],i=new n;i.load("obj/trees/1trunk1branch.obj",function(n){for(let i=0;i<2;i++){let o=new e.MeshStandardMaterial({color:11184810,roughness:.75,metalness:0,side:e.FrontSide}),r=new e.MeshStandardMaterial({color:11184810,roughness:.8,metalness:0,side:e.DoubleSide,transparent:!0,depthWrite:!1});n.children[0].geometry.computeVertexNormals(),n.children[0].geometry.rotateX(.5*Math.PI),n.children[1].geometry.computeVertexNormals(),n.children[1].geometry.rotateX(.5*Math.PI),t[i]=new e.Matrix4,x.treez[i]=new e.InstancedMesh(n.children[0].geometry,o,50),x.branchez[i]=new e.InstancedMesh(n.children[1].geometry,r,50);for(let a=0;a<50;a++)randomizeMatrix(t[i]),x.treez[i].setMatrixAt(a,t[i]),x.branchez[i].setMatrixAt(a,t[i]);x.treez[i].position.set(0,-98,300),x.branchez[i].position.set(0,-98,300),x.treez[i].castShadow=!0,x.treez[i].receiveShadow=!0,x.branchez[i].receiveShadow=!0,1==i?(grup5.add(x.treez[i]),grup5.add(x.branchez[i])):(grup6.add(x.treez[i]),grup6.add(x.branchez[i]))}var d=new e.TextureLoader,s=new e.TextureLoader,u=new e.TextureLoader,l=new e.TextureLoader;d.load("obj/trees/evergreend.jpg",function(e){for(let t=0;t<2;t++)x.treez[t].material.map=e,x.treez[t].material.needsUpdate=!0}),s.load("obj/trees/evergreenn.jpg",function(e){for(let t=0;t<2;t++)x.treez[t].material.normalScale.set(-.17,-.17),x.treez[t].material.normalMap=e,x.treez[t].material.needsUpdate=!0}),u.load("obj/trees/brancha.jpg",function(e){for(let t=0;t<2;t++)x.branchez[t].material.alphaMap=e,x.branchez[t].material.needsUpdate=!0}),l.load("obj/trees/branchd.jpg",function(e){for(let t=0;t<2;t++)x.branchez[t].material.map=e,x.branchez[t].material.bumpScale=4,x.branchez[t].material.bumpMap=e,x.branchez[t].material.needsUpdate=!0})})}function addFog(){x.kloud=[];for(let t=0;t<2;t++){let n=new e.BufferGeometry,i=[];for(let o=0;o<100;o++){let r=1200*Math.random()-600,a=40*Math.random()+-100+200,d=600*Math.random()-300;i.push(r,a,d)}n.setAttribute("position",new e.Float32BufferAttribute(i,3)),n.computeBoundingSphere();let s=new e.PointsMaterial({color:4079682,size:400,sizeAttenuation:!1,transparent:!0,depthWrite:!1,depthTest:!0,fog:!0});s.opacity=.8,x.kloud[t]=new e.Points(n,s),x.kloud[t].position.set(0,1,300),1==t?grup5.add(x.kloud[t]):grup6.add(x.kloud[t]);new e.TextureLoader().load("img/fog.png",function(e){x.kloud[t].material.map=e,x.kloud[t].material.needsUpdate=!0})}}function fadeScene(){onWindowResize(),function e(){let t=parseFloat(ui.kontainer.style.opacity);(t+=.1)>1?(ui.kontainer.style.opacity=1,onWindowResize(),entro(),isMobil?(ui.kontainer.addEventListener("touchstart",onDocumentTouchStart,!1),ui.kontainer.addEventListener("touchmove",onDocumentTouchMove,!1)):(ui.kontainer.addEventListener("mousemove",onMouseMove,!1),ui.kontainer.addEventListener("click",kontainerClick,!1)),ui.kontainer.addEventListener("pointermove",onMouseMove,!1),ui.kontainer.addEventListener("wheel",wheelE,!1),animate(),animWalk()):(ui.kontainer.style.opacity=t,requestAnimationFrame(e))}()}function animWalk(){!function e(){let t=grup5.position.z,n=grup6.position.z;t<1200?grup5.position.z=t+1:grup5.position.z=0,n<1200?grup6.position.z=n+1:grup6.position.z=0,requestAnimationFrame(e)}()}function clickTap(){ui.tempDiv&&(ui.tempDiv.parentNode.removeChild(noAud),ui.tempDiv=void 0,addAud(),isMobil||document.removeEventListener("keyup",clickTap,!1))}function onMouseMove(e){e&&e.preventDefault(),mouseX=e.clientX-win.widthH,mouseY=e.clientY-win.heightH,isMobil?(win.pointer.x=e.touches[0].pageX/win.width*2-1,win.pointer.y=-(2*(e.touches[0].pageY/win.height))+1):(win.pointer.x=e.clientX/win.width*2-1,win.pointer.y=-(2*(e.clientY/win.height))+1),mouseY-=50,win.idleTimer=0}function onMouseWheel(e){e.preventDefault(),win.idleTimer=0}function wheelE(e){e.preventDefault(),x.prevCamZ=camera.position.z,camera.position.z+=.1*e.deltaY,(camera.position.z<1120||camera.position.z>1240)&&(camera.position.z=x.prevCamZ),win.idleTimer=0}function onDocumentTouchStart(e){1===e.touches.length&&(mouseX=e.touches[0].pageX-win.widthH,mouseY=e.touches[0].pageY-win.heightH,win.pointer.x=e.touches[0].pageX/win.width*2-1,win.pointer.y=-(2*(e.touches[0].pageY/win.height))+1,clickTap(),win.idleTimer=0)}function onDocumentTouchMove(e){1===e.touches.length&&(mouseX=e.touches[0].pageX-win.widthH,mouseY=e.touches[0].pageY-win.heightH)}function onDocumentTouchEnd(e){1===e.touches.length&&(win.pointer.x=e.touches[0].pageX/win.width*2-1,win.pointer.y=-(2*(e.touches[0].pageY/win.height))+1,clickTap(),ui.kontainer.removeEventListener("touchmove",onDocumentTouchMove,!1),ui.kontainer.removeEventListener("touchend",onDocumentTouchEnd,!1),win.idleTimer=0)}function kontainerClick(e){e.preventDefault(),clickTap(),win.idleTimer=0}function onWindowResize(){if(win.width=window.innerWidth,win.height=window.innerHeight,isMobil){let e=document.documentElement.getBoundingClientRect(),t=document.documentElement.clientWidth,n=document.documentElement.clientHeight;if(e)win.width=e.width,win.height=e.height;else if(t)win.width=t,win.height=n;else{let i=win.width;win.width=win.height,win.height=i}}win.widthH=win.width/2,win.heightH=win.height/2,document.body.style.width=ui.kontainer.style.width=win.width+"px",document.body.style.height=ui.kontainer.style.height=win.height+"px",camera.aspect=win.width/win.height,camera.updateProjectionMatrix(),renderer.setSize(win.width,win.height),win.width>win.height?cntnt.style.fontSize=cntnt2.style.fontSize=(win.width+win.height)/2*.022+"px":cntnt.style.fontSize=cntnt2.style.fontSize=(win.width+win.height)/2*.028+"px",win.idleTimer=0}function animate(){if(requestAnimationFrame(animate),win.idleTimer<120){clock.running||clock.start();let e=.7*clock.getDelta();mixer&&mixer.update(e),win.idleTimer+=.01,render()}else clock.running&&clock.stop(),x.sound&&x.sound.isPlaying&&x.sound.pause();document.hasFocus()?win.fokus||(win.idleTimer=0,win.fokus=!0,x.sound&&!x.sound.isPlaying&&x.sound.play()):(win.idleTimer=120,win.fokus=!1,x.sound&&x.sound.isPlaying&&x.sound.pause()),o.update()}function render(){camera.rotation.y=-((mouseX-camera.position.x)*6e-4),camera.rotation.x=(-mouseY-camera.position.y)*6e-4,renderer.render(scene,camera)}function animFBX(){let t="teenb1/char1";t+=".fbx";let n=new i;n.load("obj/"+t,function(t){t.traverse(function(e){e.isMesh&&(e.geometry.computeBoundingBox(),e.castShadow=!0,e.receiveShadow=!0,("Hatsmesh"==e.geometry.name||"Shoesmesh"==e.geometry.name)&&(e.frustumCulled=!1))}),x.char1=t;let n=[],i="obj/teenb1/mat/";for(let o=0;o<8;o++)n[o]=new e.MeshStandardMaterial({color:13948116,roughness:.75,metalness:0}),x.char1.children[o].material=n[o];let r=new e.TextureLoader,a=new e.TextureLoader,d=new e.TextureLoader,s=new e.TextureLoader,u=new e.TextureLoader;new e.TextureLoader;let l=new e.TextureLoader,p=new e.TextureLoader,c=new e.TextureLoader,h=new e.TextureLoader,m=new e.TextureLoader;new e.TextureLoader,r.load(i+"bottomd.jpg",function(e){n[2].map=e,n[2].needsUpdate=!0}),a.load(i+"bodyd.jpg",function(e){n[3].map=e,n[3].needsUpdate=!0}),d.load(i+"hatd.jpg",function(e){n[4].map=e,n[4].needsUpdate=!0}),s.load(i+"shoesd.jpg",function(e){n[5].map=e,n[5].needsUpdate=!0}),u.load(i+"topd.jpg",function(e){n[6].map=e,n[6].needsUpdate=!0}),l.load(i+"bottomn.jpg",function(t){n[2].normalScale=new e.Vector2(-1,-1),n[2].normalMap=t,n[2].needsUpdate=!0}),p.load(i+"bodyn.jpg",function(t){n[3].normalScale=new e.Vector2(-1,-1),n[3].normalMap=t,n[3].needsUpdate=!0}),c.load(i+"hatn.jpg",function(t){n[4].normalScale=new e.Vector2(-1,-1),n[4].normalMap=t,n[4].needsUpdate=!0}),h.load(i+"shoesn.jpg",function(t){n[5].roughness=.5,n[5].normalScale=new e.Vector2(-1,-1),n[5].normalMap=t,n[5].needsUpdate=!0}),m.load(i+"topn.jpg",function(t){n[6].normalScale=new e.Vector2(-1,-1),n[6].normalMap=t,n[6].needsUpdate=!0}),x.char1.scale.set(.52,.52,.52),x.char1.position.set(0,-100,1090),x.char1.rotation.set(0,Math.PI,0),scene.add(x.char1),x.spotLight.target=x.char1,anim8()})}function anim8(){x.actions=[];let t="teenb1/walkswag";t+=".fbx";let n=new i;n.load("obj/"+t,function(t){mixer=new e.AnimationMixer(x.char1),x.actions[0]=mixer.clipAction(t.animations[0]),x.actions[0].play(),fadeScene()})}function addAud(){if(!x.sound){let t="frst1";t+=".mp3";let n=new e.AudioListener;camera.add(n),x.sound=new e.Audio(n);let i=new e.AudioLoader;i.load("aud/"+t,function(e){x.sound.setBuffer(e),x.sound.setLoop(!0),x.sound.setVolume(.4),x.sound.play()})}}



	