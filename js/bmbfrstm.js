/**
 * author Armstrong "Army" Chiu
 * URL: https://thewebdesignerpro.com/     
 */
 
 
import*as THREE from"three";import WebGL from"three/addons/capabilities/WebGL.js";import{OBJLoader}from"three/addons/loaders/OBJLoader.js";import{FBXLoader}from"three/addons/loaders/FBXLoader.js";import{Lensflare,LensflareElement}from"three/addons/objects/Lensflare.js";const idleTO=120,florY=0,ceilY=140;let camera,scene,renderer,clock;const grups=[];let mixer,isMobil=!1,mouseX=0,mouseY=-50;const ui={},_={},x={};if(WebGL.isWebGL2Available())window.addEventListener?window.addEventListener("load",init,!1):window.attachEvent?window.attachEvent("onload",init):window.onload=init;else{const e=WebGL.getWebGL2ErrorMessage();kontainer.appendChild(e),kontainer.style.background="url('img/bambooforestl.jpg') center top no-repeat",kontainer.style.backgroundSize="cover",fader.style.opacity=0,fader.style.display="none",fader.parentNode.removeChild(fader),cL(loadr,0,"paus"),loadr.style.display="none",loadr.parentNode.removeChild(loadr)}function eL(e,t,r,n){0==t?e.addEventListener(r,n,!1):e.removeEventListener(r,n,!1)}function cL(e,t,r){0==t?e.classList.contains(r)||e.classList.add(r):e.classList.contains(r)&&e.classList.remove(r)}function init(){function e(e){return document.getElementById(e)}ui.kontainer=e("kontainer"),ui.onAud=e("onAud"),ui.offAud=e("offAud"),ui.loadr=e("loadr"),ui.fader=e("fader"),ui.fader.style.opacity=1;let t=document.createElement("div");t.setAttribute("id","dummy"),document.body.appendChild(t),isMobil="9000px"!=window.getComputedStyle(t,null).getPropertyValue("left"),isMobil&&(document.addEventListener("gesturechange",(function(e){e.preventDefault()}),!1),ui.kontainer.addEventListener("gesturechange",(function(e){e.preventDefault()}),!1),_.prevW=_.prevH=0),t.parentNode.removeChild(t),_.width=window.innerWidth,_.height=window.innerHeight,document.body.style.width=ui.kontainer.style.width=_.width+"px",document.body.style.height=ui.kontainer.style.height=_.height+"px",ui.kontainer.style.backgroundColor="#d8dadc";const r=14211804;if(_.ej=[],_.ej[0]=0,_.ej[1]=-1,_.ej[2]=Math.PI,_.ej[3]=1850,_.ej[4]=0,_.ej[5]=100,x.zz=450,renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!1}),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(_.width,_.height),renderer.setClearColor(r,1),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.outputColorSpace=THREE.LinearSRGBColorSpace,renderer.sortObjects=!1,ui.kontainer.appendChild(renderer.domElement),!1===renderer.capabilities.isWebGL2&&!renderer.extensions.get("OES_texture_float"))throw alert("OES_texture_float not supported"),"missing webgl extension";if(!1===renderer.capabilities.isWebGL2&&!renderer.extensions.get("OES_texture_float_linear"))throw alert("OES_texture_float_linear not supported"),"missing webgl extension";scene=new THREE.Scene,scene.fog=new THREE.FogExp2(r,5e-4),x.camGrup=new THREE.Group,camera=new THREE.PerspectiveCamera(50,_.width/_.height,1,1e4),camera.position.set(0,_.ej[5],_.ej[3]),x.camGrup.add(camera),scene.add(new THREE.AmbientLight(14211288)),scene.add(x.camGrup);x.directionalLight=new THREE.DirectionalLight(16777215,3),x.directionalLight.castShadow=!0,x.directionalLight.shadow.mapSize.width=1024,x.directionalLight.shadow.mapSize.height=1024,x.directionalLight.shadow.camera.far=5e3,x.directionalLight.shadow.camera.left=-4e3,x.directionalLight.shadow.camera.bottom=-3e3,x.directionalLight.shadow.camera.right=4e3,x.directionalLight.shadow.camera.top=3e3,x.directionalLight.position.set(375,750,-2e3),x.directionalLight.shadow.intensity=.9,scene.add(x.directionalLight),eL(window,1,"load",init),eL(window,0,"resize",onWindowResize),x.rotCam=!1,clock=new THREE.Clock,clock.autoStart=!1,grups[0]=new THREE.Group,grups[1]=new THREE.Group,_.mouse=new THREE.Vector2,_.entro=!0,_.idleTimer=0,_.fokus=!0,_.pointer=new THREE.Vector2,_.ptrDown=!1,x.currGrup=0,x.target0=new THREE.Object3D,x.target0.position.set(0,_.ej[5],0),x.camGrup.add(x.target0),addClouds(),addGround(),addTrees(),addTreesD(),onWindowResize()}function addClouds(){const e=new THREE.SphereGeometry(2e3,32,16,0,2*Math.PI,0,Math.PI/2),t=new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide,fog:!1}),r=new THREE.Mesh(e,t);r.rotation.y=1.2,x.camGrup.add(r);let n=new THREE.TextureLoader;new THREE.TextureLoader;n.load("img/skybox/14/dome2.jpg",(function(e){r.material.map=e,r.material.needsUpdate=!0})),addSun()}function addGround(){x.ground=[];let e=new THREE.PlaneGeometry(8e3,4e3,320,160),t=new THREE.MeshStandardMaterial({color:14607838,roughness:1,metalness:0});t.wireframe=!0;for(let r=0;r<1;r++)x.ground[r]=new THREE.Mesh(e,t),x.ground[r].position.set(0,-32,0),x.ground[r].rotation.x=-.5*Math.PI,x.ground[r].receiveShadow=!0,scene.add(x.ground[r]);var r=new THREE.TextureLoader,n=new THREE.TextureLoader,a=new THREE.TextureLoader,o=new THREE.TextureLoader,d="img/ground/11/";r.load(d+"color1.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(20,10);for(let t=0;t<1;t++)x.ground[t].material.map=e,x.ground[t].material.needsUpdate=!0,x.ground[t].material.wireframe=!1})),n.load("img/snowground3.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(2,1),e.offset.set(0,.2);for(let t=0;t<1;t++)x.ground[t].material.displacementScale=80,x.ground[t].material.displacementMap=e,x.ground[t].material.needsUpdate=!0})),a.load(d+"normal1.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(20,10);for(let t=0;t<1;t++)x.ground[t].material.normalMap=e,x.ground[t].material.needsUpdate=!0})),o.load(d+"rough1.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping,e.repeat.set(20,10);for(let t=0;t<1;t++)x.ground[t].material.roughnessMap=e,x.ground[t].material.needsUpdate=!0}))}function randomizeMatrix(e){const t=new THREE.Vector3,r=new THREE.Euler,n=new THREE.Quaternion,a=new THREE.Vector3;t.y=-5,t.x=3900*Math.random()-1950;let o=1900*Math.random()+0;return o>700&&o<900&&(t.y-=50,o=o<800?-20*Math.random()+700:20*Math.random()+900),t.z=o,r.x=.2*Math.random()-.1,r.y=2*Math.random()*Math.PI,r.z=.2*Math.random()-.1,n.setFromEuler(r),a.x=a.y=a.z=15+5*Math.random(),e.compose(t,n,a)}function addTrees(){const e=[];x.trees=[];(new OBJLoader).load("obj/trees/6/tree2.obj",(function(t){t.traverse((function(e){e.isMesh&&e.geometry.computeBoundingBox()})),e[2]=new THREE.MeshStandardMaterial({color:16777215,roughness:.5}),e[1]=new THREE.MeshStandardMaterial({color:16777215,roughness:.5}),e[0]=new THREE.MeshStandardMaterial({color:16777215,roughness:.9,alphaTest:.5}),e[0].wireframe=e[1].wireframe=e[2].wireframe=!0,e[0].side=2;const r=t.children[0].geometry.attributes.position.array.length,n=t.children[1].geometry.attributes.position.array.length,a=t.children[2].geometry.attributes.position.array.length,o=200;x.trees[0]=new THREE.BatchedMesh(o,r,2*r,e[0]),x.trees[0].frustumCulled=!0,x.trees[0].castShadow=!0,x.trees[0].receiveShadow=!0,x.trees[1]=new THREE.BatchedMesh(o,n,2*n,e[1]),x.trees[1].frustumCulled=!0,x.trees[1].castShadow=!0,x.trees[1].receiveShadow=!0,x.trees[2]=new THREE.BatchedMesh(o,a,2*a,e[2]),x.trees[2].frustumCulled=!0,x.trees[2].castShadow=!0,x.trees[2].receiveShadow=!0,x.trees[3]=new THREE.BatchedMesh(o,r,2*r,e[0]),x.trees[3].frustumCulled=!0,x.trees[3].castShadow=!0,x.trees[3].receiveShadow=!0,x.trees[4]=new THREE.BatchedMesh(o,n,2*n,e[1]),x.trees[4].frustumCulled=!0,x.trees[4].castShadow=!0,x.trees[4].receiveShadow=!0,x.trees[5]=new THREE.BatchedMesh(o,a,2*a,e[2]),x.trees[5].frustumCulled=!0,x.trees[5].castShadow=!0,x.trees[5].receiveShadow=!0;const d=x.trees[0].addGeometry(t.children[0].geometry),i=x.trees[1].addGeometry(t.children[1].geometry),s=x.trees[2].addGeometry(t.children[2].geometry),l=x.trees[3].addGeometry(t.children[0].geometry),u=x.trees[4].addGeometry(t.children[1].geometry),c=x.trees[5].addGeometry(t.children[2].geometry);let h=new THREE.Matrix4;for(let e=0;e<o;e++){const e=x.trees[0].addInstance(d),t=x.trees[1].addInstance(i),r=x.trees[2].addInstance(s),n=x.trees[3].addInstance(l),a=x.trees[4].addInstance(u),o=x.trees[5].addInstance(c);h=randomizeMatrix(h),x.trees[0].setMatrixAt(e,h),x.trees[1].setMatrixAt(t,h),x.trees[2].setMatrixAt(r,h),x.trees[3].setMatrixAt(n,h),x.trees[4].setMatrixAt(a,h),x.trees[5].setMatrixAt(o,h)}grups[0].add(x.trees[0]),grups[0].add(x.trees[1]),grups[0].add(x.trees[2]),grups[1].add(x.trees[3]),grups[1].add(x.trees[4]),grups[1].add(x.trees[5]);const p=new THREE.TextureLoader,m=new THREE.TextureLoader,w=new THREE.TextureLoader,E=new THREE.TextureLoader,g=new THREE.TextureLoader,f=new THREE.TextureLoader,T=new THREE.TextureLoader,y="obj/trees/6/mat/";p.load(y+"color1.jpg",(function(t){e[1].map=t,e[1].needsUpdate=!0,e[1].wireframe=!1})),w.load(y+"color2.jpg",(function(t){e[2].map=t,e[2].needsUpdate=!0,e[2].wireframe=!1})),E.load(y+"normal2.jpg",(function(t){e[2].normalScale.set(.6,.6),e[2].normalMap=t,e[2].needsUpdate=!0})),g.load(y+"color0.jpg",(function(t){e[0].map=t,e[0].needsUpdate=!0})),f.load(y+"alfa0.jpg",(function(t){e[0].alphaMap=t,e[0].needsUpdate=!0,e[0].wireframe=!1,animFBX()})),T.load(y+"rough0.jpg",(function(t){e[0].roughnessMap=t,e[0].needsUpdate=!0})),m.load(y+"normal0.jpg",(function(t){e[0].normalScale.set(.8,.8),e[0].normalMap=t,e[0].needsUpdate=!0}))})),grups[0].position.x=-2e3,grups[1].position.x=2e3,scene.add(grups[0]),scene.add(grups[1])}function randomizeMatrix2(e){const t=new THREE.Vector3,r=new THREE.Euler,n=new THREE.Quaternion,a=new THREE.Vector3;t.y=-5,t.x=3900*Math.random()-1950;let o=-750*Math.random()-20;return t.z=o,r.x=.2*Math.random()-.1,r.y=2*Math.random()*Math.PI,r.z=.2*Math.random()-.1,n.setFromEuler(r),a.x=a.y=a.z=12+4*Math.random(),e.compose(t,n,a)}function addTreesD(){const e=[];x.treesD=[];(new OBJLoader).load("obj/trees/6/tree2dec.obj",(function(t){t.traverse((function(e){e.isMesh&&e.geometry.computeBoundingBox()})),e[2]=new THREE.MeshStandardMaterial({color:8162132,roughness:.8}),e[1]=new THREE.MeshStandardMaterial({color:6854662,roughness:.8,alphaTest:.5}),e[0]=new THREE.MeshStandardMaterial({color:8689744,roughness:.8}),e[1].wireframe=!0,e[1].side=2;const r=t.children[0].geometry.attributes.position.array.length,n=t.children[1].geometry.attributes.position.array.length,a=t.children[2].geometry.attributes.position.array.length,o=100;x.treesD[0]=new THREE.BatchedMesh(o,r,2*r,e[0]),x.treesD[0].frustumCulled=!0,x.treesD[0].castShadow=!0,x.treesD[1]=new THREE.BatchedMesh(o,n,2*n,e[1]),x.treesD[1].frustumCulled=!0,x.treesD[1].castShadow=!0,x.treesD[2]=new THREE.BatchedMesh(o,a,2*a,e[2]),x.treesD[2].frustumCulled=!0,x.treesD[3]=new THREE.BatchedMesh(o,r,2*r,e[0]),x.treesD[3].frustumCulled=!0,x.treesD[3].castShadow=!0,x.treesD[4]=new THREE.BatchedMesh(o,n,2*n,e[1]),x.treesD[4].frustumCulled=!0,x.treesD[4].castShadow=!0,x.treesD[5]=new THREE.BatchedMesh(o,a,2*a,e[2]),x.treesD[5].frustumCulled=!0;const d=x.treesD[0].addGeometry(t.children[0].geometry),i=x.treesD[1].addGeometry(t.children[1].geometry),s=x.treesD[2].addGeometry(t.children[2].geometry),l=x.treesD[3].addGeometry(t.children[0].geometry),u=x.treesD[4].addGeometry(t.children[1].geometry),c=x.treesD[5].addGeometry(t.children[2].geometry);let h=new THREE.Matrix4;for(let e=0;e<o;e++){const e=x.treesD[0].addInstance(d),t=x.treesD[1].addInstance(i),r=x.treesD[2].addInstance(s),n=x.treesD[3].addInstance(l),a=x.treesD[4].addInstance(u),o=x.treesD[5].addInstance(c);h=randomizeMatrix2(h),x.treesD[0].setMatrixAt(e,h),x.treesD[1].setMatrixAt(t,h),x.treesD[2].setMatrixAt(r,h),x.treesD[3].setMatrixAt(n,h),x.treesD[4].setMatrixAt(a,h),x.treesD[5].setMatrixAt(o,h)}grups[0].add(x.treesD[0]),grups[0].add(x.treesD[1]),grups[0].add(x.treesD[2]),grups[1].add(x.treesD[3]),grups[1].add(x.treesD[4]),grups[1].add(x.treesD[5]);(new THREE.TextureLoader).load("obj/trees/6/mat/alfa0.jpg",(function(t){e[1].alphaMap=t,e[1].needsUpdate=!0,e[1].wireframe=!1}))}))}function addSun(){let e=new THREE.TextureLoader;const t=(new THREE.TextureLoader).load("img/sun/flare3.jpg",(function(e){}));e.load("img/sun/alfa2.jpg",(function(e){const r=new Lensflare;r.addElement(new LensflareElement(e,700,0,x.directionalLight.color)),r.addElement(new LensflareElement(t,50,.4)),r.addElement(new LensflareElement(t,80,.5)),r.addElement(new LensflareElement(t,120,.6)),r.addElement(new LensflareElement(t,70,.7)),r.position.set(750,600,-1600),x.camGrup.add(r)}))}function fadeScene(){onWindowResize(),function e(){let t=parseFloat(ui.fader.style.opacity);(t-=.05)<0?(ui.fader.style.opacity=0,ui.fader.style.display="none",ui.fader.parentNode.removeChild(ui.fader),onWindowResize(),eL(ui.kontainer,0,"pointerdown",onPointerDown),eL(ui.kontainer,0,"pointermove",onPointerMove),animate(),theOptions(),cL(ui.loadr,0,"paus"),ui.loadr.style.display="none",ui.loadr.parentNode.removeChild(ui.loadr)):(ui.fader.style.opacity=t,requestAnimationFrame(e))}()}function theOptions(){isMobil?(eL(ui.onAud,0,"touchstart",audClick),eL(ui.offAud,0,"touchstart",audClick)):(eL(ui.onAud,0,"click",audClick),eL(ui.offAud,0,"click",audClick))}function audClick(e){e&&e.preventDefault(),x.sound?x.sound.isPlaying?(cL(ui.offAud,0,"noneIt2"),cL(ui.onAud,1,"noneIt2"),x.sound.pause()):(cL(ui.onAud,0,"noneIt2"),cL(ui.offAud,1,"noneIt2"),x.sound.play()):addAud(),_.idleTimer=0}function onPointerDown(e){e&&e.preventDefault();let t={};e.clientX?(t.x=e.clientX/_.width*2-1,t.y=-e.clientY/_.height*2+1):(t.x=e.x/_.width*2-1,t.y=-e.y/_.height*2+1),_.ptrDown=!0,_.pointer.x=t.x,_.pointer.y=t.y,_.idleTimer=0}function onPointerMove(e){e&&e.preventDefault();let t={};e.clientX?(t.x=e.clientX/_.width*2-1,t.y=-e.clientY/_.height*2+1):(t.x=e.x/_.width*2-1,t.y=-e.y/_.height*2+1),_.pointer.x=t.x,_.pointer.y=t.y,_.idleTimer=0}function wheelE(e){e&&e.preventDefault(),_.idleTimer=0}function onWindowResize(){_.width=window.innerWidth,_.height=window.innerHeight,isMobil&&(_.width==_.prevW&&(_.width=_.prevH,_.height=_.prevW),_.prevW=_.width,_.prevH=_.height),_.widthH=_.width/2,_.heightH=_.height/2,document.body.style.width=ui.kontainer.style.width=_.width+"px",document.body.style.height=ui.kontainer.style.height=_.height+"px",camera.aspect=_.width/_.height,camera.updateProjectionMatrix(),renderer.setSize(_.width,_.height),_.width>_.height?cntnt.style.fontSize=cntnt2.style.fontSize=(_.width+_.height)/2*.022+"px":cntnt.style.fontSize=cntnt2.style.fontSize=(_.width+_.height)/2*.028+"px",_.idleTimer=0}function animWalk(){let e=x.camGrup.position.x;x.target0.position.x;e<2e3?x.camGrup.position.x=e+1:(x.camGrup.position.x=-2e3,x.currGrup=0==x.currGrup?1:0)}function animate(){if(requestAnimationFrame(animate),_.idleTimer<idleTO){clock.running||clock.start();Date.now();const e=.4*clock.getDelta();mixer.update(e),animWalk(),camera.rotation.y=-.25*_.pointer.x,camera.rotation.x=.2*_.pointer.y,_.idleTimer+=.01,render()}else clock.running&&clock.stop(),x.sound&&x.sound.isPlaying&&x.sound.pause();document.hasFocus()?_.fokus||(_.idleTimer=0,_.fokus=!0,x.sound&&(x.sound.isPlaying||x.sound.play())):(_.idleTimer=idleTO,_.fokus=!1,x.sound&&x.sound.isPlaying&&x.sound.pause())}function render(){renderer.render(scene,camera)}function animFBX(){let e="teenb1/char1";e+=".fbx";(new FBXLoader).load("obj/teenb1/char1.fbx",(function(e){e.traverse((function(e){e.isMesh&&(e.geometry.computeBoundingBox(),e.castShadow=!0,e.receiveShadow=!0,"Hatsmesh"!=e.geometry.name&&"Shoesmesh"!=e.geometry.name||(e.frustumCulled=!1))})),x.char1=e;let t=[],r="obj/teenb1/mat/",n="jpg";for(let e=0;e<7;e++)t[e]=new THREE.MeshStandardMaterial({color:16777215,roughness:.6,metalness:0}),x.char1.children[e].material=t[e];t[1].transparent=!0,t[1].opacity=0;let a=new THREE.TextureLoader,o=new THREE.TextureLoader,d=new THREE.TextureLoader,i=new THREE.TextureLoader,s=new THREE.TextureLoader,l=(new THREE.TextureLoader,new THREE.TextureLoader),u=new THREE.TextureLoader,c=new THREE.TextureLoader,h=new THREE.TextureLoader,p=new THREE.TextureLoader;new THREE.TextureLoader;a.load(r+"bottomd."+n,(function(e){t[2].map=e,t[2].needsUpdate=!0})),o.load(r+"bodyd."+n,(function(e){t[0].map=t[3].map=e,t[0].needsUpdate=t[3].needsUpdate=!0})),d.load(r+"hatd."+n,(function(e){t[4].map=e,t[4].needsUpdate=!0})),i.load(r+"shoesd."+n,(function(e){t[5].map=e,t[5].needsUpdate=!0})),s.load(r+"topd."+n,(function(e){t[6].map=e,t[6].needsUpdate=!0})),l.load(r+"bottomn."+n,(function(e){t[2].normalMap=e,t[2].needsUpdate=!0})),u.load(r+"bodyn."+n,(function(e){t[3].normalMap=e,t[3].needsUpdate=!0})),c.load(r+"hatn."+n,(function(e){t[4].normalMap=e,t[4].needsUpdate=!0})),h.load(r+"shoesn."+n,(function(e){t[5].roughness=.4,t[5].normalMap=e,t[5].needsUpdate=!0})),p.load(r+"topn."+n,(function(e){t[6].normalMap=e,t[6].needsUpdate=!0}));x.char1.scale.set(1.1,1.1,1.1),x.char1.position.set(-130,-25,800),x.char1.rotation.set(0,Math.PI/2,0),x.camGrup.add(x.char1),anim8()}))}function anim8(){x.actions=[];let e="teenb1/walkswag";e+=".fbx";(new FBXLoader).load("obj/teenb1/walkswag.fbx",(function(e){mixer=new THREE.AnimationMixer(x.char1),x.actions[0]=mixer.clipAction(e.animations[0]),x.actions[0].play(),mixer.update(0),fadeScene()}))}function addAud(){if(!x.sound){let e="bmbfrst";e+=".mp3";const t=new THREE.AudioListener;camera.add(t),x.sound=new THREE.Audio(t);(new THREE.AudioLoader).load("aud/"+e,(function(e){x.sound.setBuffer(e),x.sound.setLoop(!0),x.sound.setVolume(.9),x.sound.play(),cL(ui.onAud,0,"noneIt2"),cL(ui.offAud,1,"noneIt2")}))}}
	