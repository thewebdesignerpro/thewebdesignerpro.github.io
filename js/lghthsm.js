/**
 * author Armstrong "Army" Chiu
 * URL: https://thewebdesignerpro.com/     
 */
 
 
import*as THREE from"three";import WebGL from"three/addons/capabilities/WebGL.js";import{vec3,Fn,time,texture3D,screenUV,uniform,screenCoordinate,pass}from"three/tsl";import{ImprovedNoise}from"three/addons/math/ImprovedNoise.js";import{bayer16}from"three/addons/tsl/math/Bayer.js";import{gaussianBlur}from"three/addons/tsl/display/GaussianBlurNode.js";import{OBJLoader}from"three/addons/loaders/OBJLoader.js";import{FBXLoader}from"three/addons/loaders/FBXLoader.js";import{WaterMesh}from"three/addons/objects/WaterMesh.js";const idleTO=120,florY=-1,ceilY=140;let camera,scene,renderer,clock;const grups=[];let mixer,isMobil=!1,mouseX=0,mouseY=-50;const ui={},_={},x={};let postProcessing,volumetricMesh,pointLight,isAvailable="undefined"!=typeof navigator&&void 0!==navigator.gpu;if(WebGL.isWebGL2Available()&&isAvailable)window.addEventListener?window.addEventListener("load",init,!1):window.attachEvent?window.attachEvent("onload",init):window.onload=init;else{const e='Your browser does not support <a href="https://gpuweb.github.io/gpuweb/" style="color:blue">WebGPU</a> yet';kontainer.appendChild(e),kontainer.style.background="url('img/lighthousel.jpg') center top no-repeat",kontainer.style.backgroundSize="cover",fader.style.opacity=0,fader.style.display="none",fader.parentNode.removeChild(fader),cL(loadr,0,"paus"),loadr.style.display="none",loadr.parentNode.removeChild(loadr)}function eL(e,t,o,a){0==t?e.addEventListener(o,a,!1):e.removeEventListener(o,a,!1)}function cL(e,t,o){0==t?e.classList.contains(o)||e.classList.add(o):e.classList.contains(o)&&e.classList.remove(o)}function init(){function e(e){return document.getElementById(e)}ui.kontainer=e("kontainer"),ui.onAud=e("onAud"),ui.offAud=e("offAud"),ui.loadr=e("loadr"),ui.fader=e("fader"),ui.fader.style.opacity=1;let t=document.createElement("div");t.setAttribute("id","dummy"),document.body.appendChild(t),isMobil="9000px"!=window.getComputedStyle(t,null).getPropertyValue("left"),isMobil&&(document.addEventListener("gesturechange",(function(e){e.preventDefault()}),!1),ui.kontainer.addEventListener("gesturechange",(function(e){e.preventDefault()}),!1),_.prevW=_.prevH=0),t.parentNode.removeChild(t),_.width=window.innerWidth,_.height=window.innerHeight,document.body.style.width=ui.kontainer.style.width=_.width+"px",document.body.style.height=ui.kontainer.style.height=_.height+"px",ui.kontainer.style.backgroundColor="#222222";_.ej=[],_.ej[0]=0,_.ej[1]=-1,_.ej[2]=Math.PI,_.ej[3]=0,_.ej[4]=0,_.ej[5]=5,x.zz=450,scene=new THREE.Scene,x.camGrup=new THREE.Group,grups[0]=new THREE.Group,scene.add(grups[0]),camera=new THREE.PerspectiveCamera(50,_.width/_.height,1,1e4),camera.position.set(0,_.ej[5],200),x.camGrup.add(camera),x.camGrup.position.set(0,0,_.ej[3]),scene.add(x.camGrup),scene.add(new THREE.AmbientLight(10066329)),clock=new THREE.Clock,clock.autoStart=!1,_.mouse=new THREE.Vector2,_.entro=!0,_.idleTimer=0,_.fokus=!0,_.pointer=new THREE.Vector2,_.ptrDown=!1,renderer=new THREE.WebGPURenderer,renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(_.width,_.height),renderer.setClearColor(2236962,1),renderer.toneMapping=THREE.NeutralToneMapping,renderer.shadowMap.enabled=!0,renderer.shadowMap.type=THREE.PCFSoftShadowMap,renderer.outputColorSpace=THREE.LinearSRGBColorSpace,renderer.sortObjects=!1,renderer.setAnimationLoop(animate),ui.kontainer.appendChild(renderer.domElement),x.spotLight=[],x.spotLight[0]=new THREE.SpotLight(16777215,1e7,2800,Math.PI/6,1),x.spotLight[0].position.set(0,1500,100),x.spotLight[0].castShadow=!0,x.spotLight[0].shadow.mapSize.width=1536,x.spotLight[0].shadow.mapSize.height=1536,x.spotLight[0].shadow.camera.near=1,x.spotLight[0].shadow.camera.far=2800,x.spotLight[0].shadow.camera.fov=50,scene.add(x.spotLight[0]),eL(window,1,"load",init),eL(window,0,"resize",onWindowResize),x.target0=new THREE.Object3D,x.target0.position.set(0,_.ej[5],0),scene.add(x.target0),x.spotLight[0].target=x.target0,x.rotCam=!1,addClouds(),onWindowResize()}function addClouds(){const e=new THREE.SphereGeometry(650,32,16,0,2*Math.PI,0,Math.PI/2),t=new THREE.MeshBasicMaterial({color:16777215,side:THREE.BackSide,fog:!1});t.transparent=!0;const o=new THREE.Mesh(e,t);scene.add(o);let a=new THREE.TextureLoader;new THREE.TextureLoader;a.load("img/skybox/0/mway3.jpg",(function(e){o.material.map=e,o.material.needsUpdate=!0})),addSea2()}function addSea2(){const e=new THREE.PlaneGeometry(1300,1300);x.sea=new WaterMesh(e,{waterNormals:(new THREE.TextureLoader).load("img/water/waternormals.jpg",(function(e){e.wrapS=e.wrapT=THREE.RepeatWrapping})),sunDirection:new THREE.Vector3,sunColor:16777215,waterColor:1916463,distortionScale:3.2}),x.sea.rotation.x=-Math.PI/2,scene.add(x.sea),addFog3D()}function addLiteHaus(){let e=0;x.litehaus=[];(new OBJLoader).load("obj/lighthouse/0/litehaus.obj",(function(t){t.traverse((function(t){t.isMesh&&(t.geometry.computeBoundingBox(),e+=1)}));const o="obj/lighthouse/0/mat/",a=[11184810,8947848,16777215,13421772];for(let o=0;o<e;o++){const e=t.children[o].geometry,n=new THREE.MeshStandardMaterial({color:a[o],roughness:.5,metalness:0});n.wireframe=!0,x.litehaus[o]=new THREE.Mesh(e,n),x.litehaus[o].rotation.set(Math.PI/-2,0,0),1==o&&(n.side=2,n.shadowSide=THREE.BackSide),2!=o&&(x.litehaus[o].castShadow=!0,x.litehaus[o].receiveShadow=!0),scene.add(x.litehaus[o])}const n=new THREE.TextureLoader,i=new THREE.TextureLoader,r=new THREE.TextureLoader,s=new THREE.TextureLoader;n.load(o+"color2.jpg",(function(e){x.litehaus[3].material.map=e,x.litehaus[3].material.wireframe=!1,x.litehaus[3].material.needsUpdate=!0})),i.load(o+"color1.jpg",(function(e){x.litehaus[1].material.map=e,x.litehaus[1].material.wireframe=!1,x.litehaus[1].material.needsUpdate=!0})),r.load(o+"alfa0b.jpg",(function(e){x.litehaus[2].material.transparent=!0,x.litehaus[2].material.alphaMap=e,x.litehaus[2].material.wireframe=!1,x.litehaus[2].material.depthWrite=!1,x.litehaus[2].material.needsUpdate=!0})),s.load(o+"color3.jpg",(function(e){x.litehaus[0].material.map=e,x.litehaus[0].material.wireframe=!1,x.litehaus[0].material.needsUpdate=!0}));const d=new THREE.PlaneGeometry(100,100),l=new THREE.MeshBasicMaterial({color:16775918,depthWrite:!1,side:2});l.transparent=!0,l.opacity=.7,l.wireframe=!0,x.Sun=new THREE.Mesh(d,l),x.Sun.position.set(0,67,-7),scene.add(x.Sun);(new THREE.TextureLoader).load("img/sun/alfa2.jpg",(function(e){l.alphaMap=e,l.needsUpdate=!0,l.wireframe=!1}));const u=new THREE.BoxGeometry(220,1e-4,680),c=new THREE.MeshBasicMaterial({color:16775918,depthWrite:!1,side:1});c.transparent=!0,c.opacity=.1,c.wireframe=!0,x.beam=new THREE.Mesh(u,c),x.beam.position.set(0,65,-7),x.beam.rotation.set(Math.PI/2,0,0),scene.add(x.beam);(new THREE.TextureLoader).load("img/spotLcone2.jpg",(function(e){e.wrapS=e.wrapT=THREE.MirroredRepeatWrapping,e.repeat.set(1,2),c.alphaMap=e,c.needsUpdate=!0,c.wireframe=!1})),addBuoy()}))}function addBuoy(){let e=0;(new OBJLoader).load("obj/buoy/0/buoy4.obj",(function(t){t.traverse((function(t){t.isMesh&&(t.geometry.computeBoundingBox(),t.castShadow=!0,t.receiveShadow=!0,e+=1)})),x.buoy=t;const o=[];for(let t=0;t<e;t++)o[t]=new THREE.MeshStandardMaterial({color:16777215,roughness:.5,metalness:.2}),o[t].wireframe=!0,x.buoy.children[t].material=o[t];x.buoy.scale.set(.2,.2,.2),x.buoy.position.set(7,-.5,155),x.buoy.rotation.set(0,Math.PI/2,0),scene.add(x.buoy);(new THREE.TextureLoader).load("obj/buoy/0/mat/color4.jpg",(function(e){x.buoy.children[0].material.map=e,x.buoy.children[0].material.needsUpdate=!0,x.buoy.children[0].material.wireframe=!1})),addBoat()}))}function addBoat(){let e=0;(new OBJLoader).load("obj/boat/0/boat.obj",(function(t){t.traverse((function(t){t.isMesh&&(t.geometry.computeBoundingBox(),t.castShadow=!0,t.receiveShadow=!0,e+=1)})),x.boat=t;const o=[],a="obj/boat/0/mat/";for(let t=0;t<e;t++)o[t]=new THREE.MeshStandardMaterial({color:16777215,roughness:1,metalness:0}),o[t].wireframe=!0,x.boat.children[t].material=o[t];x.boat.scale.set(4.4,4.4,4.4),x.boat.rotation.set(0,Math.PI/2,0),grups[0].add(x.boat),grups[0].position.set(-3.8,.9,182);const n=new THREE.TextureLoader,i=new THREE.TextureLoader,r=new THREE.TextureLoader;n.load(a+"color1.jpg",(function(e){x.boat.children[0].material.map=e,x.boat.children[0].material.needsUpdate=!0,x.boat.children[0].material.wireframe=!1})),i.load(a+"rough1.jpg",(function(e){x.boat.children[0].material.roughnessMap=e,x.boat.children[0].material.needsUpdate=!0})),r.load(a+"normal1.jpg",(function(e){x.boat.children[0].material.normalMap=e,x.boat.children[0].material.needsUpdate=!0})),animFBX()}))}function createTexture3D(){let e=0;const t=128,o=new Uint8Array(2097152),a=new ImprovedNoise;for(let n=0;n<t;n++)for(let i=0;i<t;i++)for(let r=0;r<t;r++){const s=r/t*5,d=i/t*5,l=n/t*5,u=a.noise(10*s,10*d,10*l);o[e]=128+128*u,e++}const n=new THREE.Data3DTexture(o,t,t,t);return n.format=THREE.RedFormat,n.minFilter=THREE.LinearFilter,n.magFilter=THREE.LinearFilter,n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.unpackAlignment=1,n.needsUpdate=!0,n}function addFog3D(){const e=createTexture3D(),t=uniform(1.5),o=new THREE.VolumeNodeMaterial;o.steps=12,o.offsetNode=bayer16(screenCoordinate),o.scatteringNode=Fn((({positionRay:o})=>{const a=vec3(time,0,time.mul(.3)),n=(t,n=1)=>texture3D(e,o.add(a.mul(n)).mul(t).mod(1),0).r.add(.5);let i=n(.1);return i=i.mul(n(.05,1)),i=i.mul(n(.02,2)),t.mix(1,i)})),volumetricMesh=new THREE.Mesh(new THREE.BoxGeometry(1300,500,1300),o),volumetricMesh.receiveShadow=!0,volumetricMesh.position.y=252,volumetricMesh.layers.disableAll(),volumetricMesh.layers.enable(10),scene.add(volumetricMesh),pointLight=new THREE.PointLight(16775918,1100,650),pointLight.castShadow=!0,pointLight.position.set(0,65,-7),pointLight.layers.enable(10),scene.add(pointLight),x.spotLight[1]=new THREE.SpotLight(16775918,12e3,550,Math.PI/9.5,1),x.spotLight[1].position.set(0,67,-7),x.spotLight[1].castShadow=!0,x.spotLight[1].shadow.camera.near=1,x.spotLight[1].shadow.camera.far=500,x.spotLight[1].shadow.camera.fov=50,x.spotLight[1].shadow.bias=-.003,x.spotLight[1].layers.enable(10),scene.add(x.spotLight[1]),x.target1=new THREE.Object3D,x.target1.position.set(-100,67,-7),scene.add(x.target1),x.spotLight[1].target=x.target1,x.spotLight[2]=new THREE.SpotLight(16775918,12e3,550,Math.PI/9.5,1),x.spotLight[2].position.set(0,67,-7),x.spotLight[2].castShadow=!0,x.spotLight[2].shadow.camera.near=1,x.spotLight[2].shadow.camera.far=500,x.spotLight[2].shadow.camera.fov=50,x.spotLight[2].shadow.bias=-.003,x.spotLight[2].layers.enable(10),scene.add(x.spotLight[2]),x.target2=new THREE.Object3D,x.target2.position.set(100,67,-7),scene.add(x.target2),x.spotLight[2].target=x.target2,postProcessing=new THREE.PostProcessing(renderer);const a=uniform(1),n=new THREE.Layers;n.disableAll(),n.enable(10);const i=pass(scene,camera),r=i.getTextureNode("depth");o.depthNode=r.sample(screenUV);const s=pass(scene,camera,{depthBuffer:!1});s.setLayers(n),s.setResolution(.17);const d=uniform(.56),l=gaussianBlur(s,d),u=i.add(l.mul(a));postProcessing.outputNode=u,addLiteHaus()}function fadeScene(){onWindowResize(),function e(){let t=parseFloat(ui.fader.style.opacity);(t-=.1)<0?(ui.fader.style.opacity=0,ui.fader.style.display="none",ui.fader.parentNode.removeChild(ui.fader),onWindowResize(),eL(ui.kontainer,0,"pointerdown",onPointerDown),eL(ui.kontainer,0,"pointermove",onPointerMove),eL(ui.kontainer,0,"click",kontainerClick),eL(ui.kontainer,0,"wheel",wheelE),x.camV3=new THREE.Vector3,theOptions(),cL(ui.loadr,0,"paus"),ui.loadr.style.display="none",ui.loadr.parentNode.removeChild(ui.loadr),x.fogIdx=0,x.fogInc=1):(ui.fader.style.opacity=t,requestAnimationFrame(e))}()}function theOptions(){isMobil?(eL(ui.onAud,0,"touchstart",audClick),eL(ui.offAud,0,"touchstart",audClick)):(eL(ui.onAud,0,"click",audClick),eL(ui.offAud,0,"click",audClick))}function audClick(e){e&&e.preventDefault(),x.sound?x.sound.isPlaying?(cL(ui.offAud,0,"noneIt2"),cL(ui.onAud,1,"noneIt2"),x.sound.pause()):(cL(ui.onAud,0,"noneIt2"),cL(ui.offAud,1,"noneIt2"),x.sound.play()):addAud(),_.idleTimer=0}function onPointerDown(e){e&&e.preventDefault();let t={};e.clientX?(t.x=e.clientX/_.width*2-1,t.y=-e.clientY/_.height*2+1):(t.x=e.x/_.width*2-1,t.y=-e.y/_.height*2+1),_.ptrDown=!0,_.pointer.x=t.x,_.pointer.y=t.y,_.idleTimer=0}function onPointerMove(e){e&&e.preventDefault();let t={};e.clientX?(t.x=e.clientX/_.width*2-1,t.y=-e.clientY/_.height*2+1):(t.x=e.x/_.width*2-1,t.y=-e.y/_.height*2+1),_.pointer.x=t.x,_.pointer.y=t.y,_.idleTimer=0}function kontainerClick(e){e&&e.preventDefault(),_.idleTimer=0}function wheelE(e){e&&e.preventDefault(),_.idleTimer=0}function onWindowResize(){_.width=window.innerWidth,_.height=window.innerHeight,isMobil&&(_.width==_.prevW&&(_.width=_.prevH,_.height=_.prevW),_.prevW=_.width,_.prevH=_.height,x.rotCam=!0),_.widthH=_.width/2,_.heightH=_.height/2,document.body.style.width=ui.kontainer.style.width=_.width+"px",document.body.style.height=ui.kontainer.style.height=_.height+"px",camera.aspect=_.width/_.height,camera.updateProjectionMatrix(),renderer.setSize(_.width,_.height),x.zz=450,_.width>_.height?(cntnt.style.fontSize=cntnt2.style.fontSize=(_.width+_.height)/2*.022+"px",x.zz=450):(cntnt.style.fontSize=cntnt2.style.fontSize=(_.width+_.height)/2*.028+"px",x.zz=600),_.idleTimer=0}function animate(){if(_.idleTimer<idleTO){clock.running||clock.start();const e=.001*Date.now(),t=.5*clock.getDelta();mixer&&mixer.update(t),isMobil?(camera.position.x=23*Math.sin(.3*e),camera.position.y=16*Math.sin(.2*e)+17):(camera.position.x=23*_.pointer.x,camera.position.y=16*_.pointer.y+17),camera.position.z=1.5*camera.position.y+188-Math.abs(.6*camera.position.x);const o=Math.sin(.8*e);if(x.char1&&grups[0].rotation.set(.04*o,0,.07*Math.sin(e)),x.buoy&&(x.buoy.rotation.set(.2*Math.cos(e),0,.2*o),x.buoy.position.y=.3*o-.7),x.target2){const t=.5*e;x.target1.position.set(100*Math.sin(t),67,100*Math.cos(t)-7),x.target2.position.set(-1*x.target1.position.x,67,-1*x.target1.position.z),x.beam&&x.beam.lookAt(x.target1.position)}_.idleTimer+=.01,render()}else clock.running&&clock.stop(),x.sound&&x.sound.isPlaying&&x.sound.pause();document.hasFocus()?_.fokus||(_.idleTimer=0,_.fokus=!0,x.sound&&(x.sound.isPlaying||x.sound.play())):(_.idleTimer=idleTO,_.fokus=!1,x.sound&&x.sound.isPlaying&&x.sound.pause())}function render(){camera.lookAt(x.target0.position),x.Sun&&x.Sun.lookAt(camera.position),postProcessing.render()}function animFBX(){let e="teenb1/char1";e+=".fbx";(new FBXLoader).load("obj/teenb1/char1.fbx",(function(e){e.traverse((function(e){e.isMesh&&(e.geometry.computeBoundingBox(),e.castShadow=!0,e.receiveShadow=!0,"Hatsmesh"!=e.geometry.name&&"Shoesmesh"!=e.geometry.name||(e.frustumCulled=!1))})),x.char1=e;let t=[],o="obj/teenb1/mat/",a="jpg";for(let e=0;e<7;e++)t[e]=new THREE.MeshStandardMaterial({color:16777215,roughness:.6,metalness:0}),x.char1.children[e].material=t[e];t[1].transparent=!0,t[1].opacity=0;let n=new THREE.TextureLoader,i=new THREE.TextureLoader,r=new THREE.TextureLoader,s=new THREE.TextureLoader,d=new THREE.TextureLoader,l=(new THREE.TextureLoader,new THREE.TextureLoader),u=new THREE.TextureLoader,c=new THREE.TextureLoader,p=new THREE.TextureLoader,h=new THREE.TextureLoader;new THREE.TextureLoader;n.load(o+"bottomd."+a,(function(e){t[2].map=e,t[2].needsUpdate=!0})),i.load(o+"bodyd."+a,(function(e){t[0].map=t[3].map=e,t[0].needsUpdate=t[3].needsUpdate=!0})),r.load(o+"hatd."+a,(function(e){t[4].map=e,t[4].needsUpdate=!0})),s.load(o+"shoesd."+a,(function(e){t[5].map=e,t[5].needsUpdate=!0})),d.load(o+"topd."+a,(function(e){t[6].map=e,t[6].needsUpdate=!0})),l.load(o+"bottomn."+a,(function(e){t[2].normalMap=e,t[2].needsUpdate=!0})),u.load(o+"bodyn."+a,(function(e){t[3].normalMap=e,t[3].needsUpdate=!0})),c.load(o+"hatn."+a,(function(e){t[4].normalMap=e,t[4].needsUpdate=!0})),p.load(o+"shoesn."+a,(function(e){t[5].roughness=.4,t[5].normalMap=e,t[5].needsUpdate=!0})),h.load(o+"topn."+a,(function(e){t[6].normalMap=e,t[6].needsUpdate=!0}));const m=.03;x.char1.scale.set(m,m,m),x.char1.position.set(0,-1.2,1.3),x.char1.rotation.set(0,Math.PI,0),grups[0].add(x.char1),anim8()}))}function anim8(){x.actions=[];let e="teenb1/Sitting";e+=".fbx";(new FBXLoader).load("obj/teenb1/Sitting.fbx",(function(e){mixer=new THREE.AnimationMixer(x.char1),x.actions[0]=mixer.clipAction(e.animations[0]),x.actions[0].play(),mixer.update(0),fadeScene()}))}function addAud(){if(!x.sound){let e="lghths";e+=".mp3";const t=new THREE.AudioListener;camera.add(t),x.sound=new THREE.Audio(t);(new THREE.AudioLoader).load("aud/"+e,(function(e){x.sound.setBuffer(e),x.sound.setLoop(!0),x.sound.setVolume(.9),x.sound.play(),cL(ui.onAud,0,"noneIt2"),cL(ui.offAud,1,"noneIt2")}))}}
	