/**
 * author Armstrong "Army" Chiu
 * URL: https://thewebdesignerpro.com/     
 */
 
 
import*as e from"three";import t from"three/addons/capabilities/WebGL.js";import{OBJLoader as n}from"three/addons/loaders/OBJLoader.js";import{FBXLoader as o}from"three/addons/loaders/FBXLoader.js";let idleTO=120,florY=-10,ceilY=140,camera,scene,renderer,clock,grups=[],isMobil=!1,mouseX=0,mouseY=-50,mixer,ui={},_={},x={};if(t.isWebGL2Available())window.addEventListener?window.addEventListener("load",init,!1):window.attachEvent?window.attachEvent("onload",init):window.onload=init;else{let a=t.getWebGL2ErrorMessage();kontainer.appendChild(a),kontainer.style.background="url('img/winterl.jpg') center top no-repeat",kontainer.style.backgroundSize="cover",fader.style.opacity=0,fader.style.display="none",fader.parentNode.removeChild(fader),cL(loadr,0,"paus"),loadr.style.display="none",loadr.parentNode.removeChild(loadr)}function eL(e,t,n,o){0==t?e.addEventListener(n,o,!1):e.removeEventListener(n,o,!1)}function cL(e,t,n){0==t?e.classList.contains(n)||e.classList.add(n):e.classList.contains(n)&&e.classList.remove(n)}function init(){function t(e){return document.getElementById(e)}ui.kontainer=t("kontainer"),ui.onAud=t("onAud"),ui.offAud=t("offAud"),ui.loadr=t("loadr"),ui.fader=t("fader"),ui.fader.style.opacity=1;let n=document.createElement("div");if(n.setAttribute("id","dummy"),document.body.appendChild(n),(isMobil="9000px"!=window.getComputedStyle(n,null).getPropertyValue("left"))&&(document.addEventListener("gesturechange",function(e){e.preventDefault()},!1),ui.kontainer.addEventListener("gesturechange",function(e){e.preventDefault()},!1),_.prevW=_.prevH=0),n.parentNode.removeChild(n),_.width=window.innerWidth,_.height=window.innerHeight,document.body.style.width=ui.kontainer.style.width=_.width+"px",document.body.style.height=ui.kontainer.style.height=_.height+"px",ui.kontainer.style.backgroundColor="#d4dbe0",_.ej=[],_.ej[0]=0,_.ej[1]=-1,_.ej[2]=Math.PI,_.ej[3]=1200,_.ej[4]=0,_.ej[5]=50,x.xx=400,(renderer=new e.WebGLRenderer({antialias:!0,alpha:!1})).setPixelRatio(window.devicePixelRatio),renderer.setSize(_.width,_.height),renderer.setClearColor(13949920,1),renderer.shadowMap.enabled=!0,renderer.shadowMap.type=e.PCFSoftShadowMap,renderer.outputColorSpace=e.LinearSRGBColorSpace,renderer.sortObjects=!1,ui.kontainer.appendChild(renderer.domElement),!1===renderer.capabilities.isWebGL2&&!renderer.extensions.get("OES_texture_float"))throw alert("OES_texture_float not supported"),"missing webgl extension";if(!1===renderer.capabilities.isWebGL2&&!renderer.extensions.get("OES_texture_float_linear"))throw alert("OES_texture_float_linear not supported"),"missing webgl extension";(scene=new e.Scene).fog=new e.FogExp2(13949920,.002),x.camGrup=new e.Group,grups[0]=new e.Group,grups[1]=new e.Group,(camera=new e.PerspectiveCamera(50,_.width/_.height,.5,2e4)).position.set(0,_.ej[5],-100),x.camGrup.add(camera),scene.add(new e.AmbientLight(7895160)),x.spotLight=[],x.spotLight[0]=new e.SpotLight(16777215,1e8,1e4,Math.PI/8,1),x.spotLight[0].position.set(0,5e3,0),x.spotLight[0].castShadow=!0,x.spotLight[0].shadow.camera.near=1,x.spotLight[0].shadow.camera.far=1e4,x.spotLight[0].shadow.camera.fov=50;let o=new e.DirectionalLight(16777215,3);o.castShadow=!0,o.shadow.camera.far=500,o.shadow.camera.left=-700,o.shadow.camera.bottom=-1200,o.shadow.camera.right=700,o.shadow.camera.top=1200,o.position.set(0,300,0),o.shadow.intensity=.7,scene.add(o),x.camGrup.position.set(0,0,_.ej[3]),scene.add(x.camGrup),eL(window,1,"load",init),eL(window,0,"resize",onWindowResize),(clock=new e.Clock).autoStart=!1,_.mouse=new e.Vector2,_.entro=!0,_.idleTimer=0,_.fokus=!0,_.pointer=new e.Vector2,_.ptrDown=!1,x.currGrup=0,x.target0=new e.Object3D,x.target0.position.set(0,_.ej[5]/2,x.camGrup.position.z-200),scene.add(x.target0),x.snowIt=[],x.snowIt[0]=0,x.snowIt[1]=2,addClouds(),addGround(),addTrees(),onWindowResize()}function addClouds(){let t=new e.SphereGeometry(4900,24,12,0,Math.PI),n=new e.MeshBasicMaterial({color:16777215,side:e.BackSide,fog:!1});n.transparent=!0;let o=new e.Mesh(t,n);o.rotation.set(-(Math.PI/2),0,-(Math.PI/2)),scene.add(o);let a=new e.TextureLoader,i=new e.TextureLoader;a.load("img/clouds1.jpg",function(e){o.material.map=e,o.material.needsUpdate=!0}),i.load("img/opac1.jpg",function(e){o.material.alphaMap=e,o.material.needsUpdate=!0})}function addGround(){x.ground=[];let t=new e.PlaneGeometry(1400,1202,100,100),n=new e.MeshStandardMaterial({color:15658734,roughness:.9,metalness:0});for(let o=0;o<2;o++)x.ground[o]=new e.Mesh(t,n),x.ground[o].position.set(0,-10,0),x.ground[o].rotation.x=-.5*Math.PI,x.ground[o].receiveShadow=!0,grups[o].add(x.ground[o]);var a=new e.TextureLoader,i=new e.TextureLoader,r=new e.TextureLoader,s=new e.TextureLoader;a.load("img/ground/snow/color1.jpg",function(e){for(let t=0;t<2;t++)x.ground[t].material.map=e,x.ground[t].material.needsUpdate=!0}),i.load("img/snowground.jpg",function(e){for(let t=0;t<2;t++)x.ground[t].material.displacementScale=40,x.ground[t].material.displacementBias=-5,x.ground[t].material.displacementMap=e,x.ground[t].material.needsUpdate=!0}),r.load("img/ground/snow/normal1.jpg",function(e){for(let t=0;t<2;t++)x.ground[t].material.normalScale.set(1.5,1.5),x.ground[t].material.normalMap=e,x.ground[t].material.needsUpdate=!0}),s.load("img/ground/snow/rough1.jpg",function(e){for(let t=0;t<2;t++)x.ground[t].material.roughnessMap=e,x.ground[t].material.needsUpdate=!0}),grups[0].position.z=600,grups[1].position.z=-600,scene.add(grups[0]),scene.add(grups[1]),addSnow()}function randomizeMatrix(t){let n=new e.Vector3,o=new e.Euler,a=new e.Quaternion,i=new e.Vector3,r=1200*Math.random()-600;return r>-40&&r<40&&(r=42*(.5>Math.random()?-1:1)),n.x=r,n.y=-10,n.z=1100*Math.random()-550,o.y=2*Math.random()*Math.PI,a.setFromEuler(o),i.x=i.y=i.z=4+2*Math.random(),t.compose(n,a,i)}function addTrees(){x.materials2=[],x.leaves=[],x.trunk=[];let t=new n;t.load("obj/trees/8/pine.obj",function(t){t.traverse(function(e){e.isMesh}),x.materials2[0]=new e.MeshStandardMaterial({color:16777215,roughness:.7,alphaTest:.5}),x.materials2[0].shadowSide=e.FrontSide,x.materials2[1]=new e.MeshStandardMaterial({color:16777215,roughness:.8});for(let n=0;n<2;n++){let o=t.children[0].geometry.attributes.position.array.length,a=t.children[1].geometry.attributes.position.array.length;x.leaves[n]=new e.BatchedMesh(70,o,2*o,x.materials2[0]),x.leaves[n].frustumCulled=!0,x.leaves[n].castShadow=x.leaves[n].receiveShadow=!0,x.trunk[n]=new e.BatchedMesh(70,a,2*a,x.materials2[1]),x.trunk[n].frustumCulled=!0,x.trunk[n].castShadow=x.trunk[n].receiveShadow=!0;let i=x.leaves[n].addGeometry(t.children[0].geometry),r=x.trunk[n].addGeometry(t.children[1].geometry),s=new e.Matrix4;for(let d=0;d<70;d++){let $=x.leaves[n].addInstance(i),l=x.trunk[n].addInstance(r);s=randomizeMatrix(s),x.leaves[n].setMatrixAt($,s),x.trunk[n].setMatrixAt(l,s)}0==n?(grups[0].add(x.leaves[n]),grups[0].add(x.trunk[n])):(grups[1].add(x.leaves[n]),grups[1].add(x.trunk[n])),x.leaves[n].visible=x.trunk[n].visible=!1}let u=new e.TextureLoader,p=new e.TextureLoader;u.load("obj/trees/8/color1.jpg",function(e){x.materials2[0].map=x.materials2[1].map=e,x.materials2[0].needsUpdate=x.materials2[1].needsUpdate=!0;for(let t=0;t<2;t++)x.trunk[t].visible=!0}),p.load("obj/trees/8/alfa1.jpg",function(e){x.materials2[0].alphaMap=e,x.materials2[0].needsUpdate=!0;for(let t=0;t<2;t++)x.leaves[t].visible=!0})})}function randMatrix(t){let n=new e.Vector3,o=new e.Euler,a=new e.Quaternion,i=new e.Vector3;return n.x=900*Math.random()-450,n.y=500*Math.random()-250,n.z=1200*Math.random()-600,a.setFromEuler(o),i.x=i.y=.1*Math.random()+1,t.compose(n,a,i)}function addSnow(){let t=[];x.snowMesh=[],x.material=[];let n=[];n[0]=new e.PlaneGeometry(2,2),x.material[0]=new e.MeshBasicMaterial({color:15397366,transparent:!0}),x.material[0].depthWrite=!1;for(let o=0;o<4;o++){let a=n[0].attributes.position.array.length;x.snowMesh[o]=new e.BatchedMesh(1700,a,2*a,x.material[0]),x.snowMesh[o].frustumCulled=!0;let i=x.snowMesh[o].addGeometry(n[0]);t[o]=new e.Matrix4;for(let r=0;r<1700;r++){let s=x.snowMesh[o].addInstance(i);x.snowMesh[o].setMatrixAt(s,randMatrix(t[o]))}x.snowMesh[o].position.y=350,o<2?grups[0].add(x.snowMesh[o]):grups[1].add(x.snowMesh[o])}new e.TextureLoader;new e.TextureLoader().load("img/spotL2.jpg",function(e){x.material[0].alphaMap=e,x.material[0].needsUpdate=!0,animFBX()})}function fadeScene(){onWindowResize(),function t(){let n=parseFloat(ui.fader.style.opacity);(n-=.05)<0?(ui.fader.style.opacity=0,ui.fader.style.display="none",ui.fader.parentNode.removeChild(ui.fader),onWindowResize(),eL(ui.kontainer,0,"pointerdown",onPointerDown),eL(ui.kontainer,0,"pointermove",onPointerMove),x.camV3=new e.Vector3,animate(),theOptions(),cL(ui.loadr,0,"paus"),ui.loadr.style.display="none",ui.loadr.parentNode.removeChild(ui.loadr),x.fogIdx=0,x.fogInc=1):(ui.fader.style.opacity=n,requestAnimationFrame(t))}()}function theOptions(){isMobil?(eL(ui.onAud,0,"touchstart",audClick),eL(ui.offAud,0,"touchstart",audClick)):(eL(ui.onAud,0,"click",audClick),eL(ui.offAud,0,"click",audClick))}function audClick(e){e&&e.preventDefault(),x.sound?x.sound.isPlaying?(cL(ui.offAud,0,"noneIt2"),cL(ui.onAud,1,"noneIt2"),x.sound.pause()):(cL(ui.onAud,0,"noneIt2"),cL(ui.offAud,1,"noneIt2"),x.sound.play()):addAud(),_.idleTimer=0}function onPointerDown(e){e&&e.preventDefault();let t={};e.clientX?(t.x=e.clientX/_.width*2-1,t.y=-(2*(e.clientY/_.height))+1):(t.x=e.x/_.width*2-1,t.y=-(2*(e.y/_.height))+1),_.ptrDown=!0,_.pointer.x=t.x,_.pointer.y=t.y,_.idleTimer=0}function onPointerMove(e){e&&e.preventDefault();let t={};e.clientX?(t.x=e.clientX/_.width*2-1,t.y=-(2*(e.clientY/_.height))+1):(t.x=e.x/_.width*2-1,t.y=-(2*(e.y/_.height))+1),_.pointer.x=t.x,_.pointer.y=t.y,_.idleTimer=0}function wheelE(e){e&&e.preventDefault(),_.idleTimer=0}function onWindowResize(){_.width=window.innerWidth,_.height=window.innerHeight,isMobil&&(_.width==_.prevW&&(_.width=_.prevH,_.height=_.prevW),_.prevW=_.width,_.prevH=_.height),_.widthH=_.width/2,_.heightH=_.height/2,document.body.style.width=ui.kontainer.style.width=_.width+"px",document.body.style.height=ui.kontainer.style.height=_.height+"px",camera.aspect=_.width/_.height,camera.updateProjectionMatrix(),renderer.setSize(_.width,_.height),x.xx=400,_.width>_.height?(cntnt.style.fontSize=cntnt2.style.fontSize=(_.width+_.height)/2*.022+"px",isMobil&&(x.xx=800)):(cntnt.style.fontSize=cntnt2.style.fontSize=(_.width+_.height)/2*.028+"px",isMobil&&(x.xx=1100)),_.idleTimer=0}function animWalk(){let e=x.camGrup.position.z,t=x.target0.position.z;if(e>_.ej[0])x.camGrup.position.z=e+_.ej[1],x.target0.position.z=t+_.ej[1];else{x.camGrup.position.z=_.ej[3],x.target0.position.z=_.ej[3]-200,grups[0].position.z*=-1,grups[1].position.z*=-1,x.currGrup=0==x.currGrup?1:0,x.fogIdx+=x.fogInc,(0==x.fogIdx||8==x.fogIdx)&&(x.fogInc*=-1);let n=[13949920,12897232,11844544,10791856,9739168,8686480,7633792,6581104,5528416];scene.fog.color.setHex(n[x.fogIdx]),renderer.setClearColor(n[x.fogIdx],1)}600==x.camGrup.position.z&&(x.snowIt[0]=Math.abs(x.snowIt[0]-2),x.snowIt[1]=Math.abs(x.snowIt[1]-2))}function animate(){if(requestAnimationFrame(animate),_.idleTimer<120){clock.running||clock.start();let e=.001*Date.now(),t=.85*clock.getDelta();mixer&&mixer.update(t),camera.position.x=2*Math.cos(5*e),camera.position.y=3*Math.sin(10*e)+_.ej[5],isMobil?(camera.position.x+=50*Math.cos(.5*e),camera.position.y+=20*Math.sin(.5*e)):(camera.position.x+=50*_.pointer.x,camera.position.y+=20*_.pointer.y),x.snowMesh[x.snowIt[0]].position.y=x.snowMesh[x.snowIt[0]].position.y>-250?x.snowMesh[x.snowIt[0]].position.y-=.5:350,x.snowMesh[x.snowIt[0]+1].position.y=x.snowMesh[x.snowIt[0]+1].position.y>-250?x.snowMesh[x.snowIt[0]+1].position.y-=.3:350,x.snowMesh[x.snowIt[0]].rotation.y=.05*Math.cos(1.3*e),x.snowMesh[x.snowIt[0]+1].rotation.y=.04*Math.sin(.8*e),x.camGrup.position.z<600&&(x.snowMesh[x.snowIt[1]].position.y=x.snowMesh[x.snowIt[1]].position.y>-250?x.snowMesh[x.snowIt[1]].position.y-=.5:350,x.snowMesh[x.snowIt[1]+1].position.y=x.snowMesh[x.snowIt[1]+1].position.y>-250?x.snowMesh[x.snowIt[1]+1].position.y-=.3:350,x.snowMesh[x.snowIt[1]].rotation.y=.05*Math.cos(1.3*e),x.snowMesh[x.snowIt[1]+1].rotation.y=.04*Math.sin(.8*e)),animWalk(),_.idleTimer+=.01,render()}else clock.running&&clock.stop(),x.sound&&x.sound.isPlaying&&x.sound.pause();document.hasFocus()?_.fokus||(_.idleTimer=0,_.fokus=!0,x.sound&&!x.sound.isPlaying&&x.sound.play()):(_.idleTimer=120,_.fokus=!1,x.sound&&x.sound.isPlaying&&x.sound.pause())}function render(){camera.lookAt(x.target0.position),renderer.render(scene,camera)}function animFBX(){let t="teenb1/char1";t+=".fbx";let n=new o;n.load("obj/"+t,function(t){t.traverse(function(e){e.isMesh&&(e.geometry.computeBoundingBox(),e.castShadow=!0,e.receiveShadow=!0,("Hatsmesh"==e.geometry.name||"Shoesmesh"==e.geometry.name)&&(e.frustumCulled=!1))}),x.char1=t;let n=[],o="obj/teenb1/mat/";for(let a=0;a<7;a++)n[a]=new e.MeshStandardMaterial({color:16777215,roughness:.6,metalness:0}),x.char1.children[a].material=n[a];n[1].transparent=!0,n[1].opacity=0;let i=new e.TextureLoader,r=new e.TextureLoader,s=new e.TextureLoader,d=new e.TextureLoader,$=new e.TextureLoader;new e.TextureLoader;let l=new e.TextureLoader,u=new e.TextureLoader,p=new e.TextureLoader,c=new e.TextureLoader,h=new e.TextureLoader;new e.TextureLoader,i.load(o+"bottomd.jpg",function(e){n[2].map=e,n[2].needsUpdate=!0}),r.load(o+"bodyd.jpg",function(e){n[0].map=n[3].map=e,n[0].needsUpdate=n[3].needsUpdate=!0}),s.load(o+"hatd.jpg",function(e){n[4].map=e,n[4].needsUpdate=!0}),d.load(o+"shoesd.jpg",function(e){n[5].map=e,n[5].needsUpdate=!0}),$.load(o+"topd.jpg",function(e){n[6].map=e,n[6].needsUpdate=!0}),l.load(o+"bottomn.jpg",function(e){n[2].normalMap=e,n[2].needsUpdate=!0}),u.load(o+"bodyn.jpg",function(e){n[3].normalMap=e,n[3].needsUpdate=!0}),p.load(o+"hatn.jpg",function(e){n[4].normalMap=e,n[4].needsUpdate=!0}),c.load(o+"shoesn.jpg",function(e){n[5].roughness=.4,n[5].normalMap=e,n[5].needsUpdate=!0}),h.load(o+"topn.jpg",function(e){n[6].normalMap=e,n[6].needsUpdate=!0}),x.char1.scale.set(.38,.38,.38),x.char1.position.set(0,-12,-150),x.char1.rotation.set(0,Math.PI,0),x.camGrup.add(x.char1),anim8()})}function anim8(){x.actions=[];let t="teenb1/walkswag";t+=".fbx";let n=new o;n.load("obj/"+t,function(t){mixer=new e.AnimationMixer(x.char1),x.actions[0]=mixer.clipAction(t.animations[0]),x.actions[0].play(),mixer.update(0),fadeScene()})}function addAud(){if(!x.sound){let t="wntr";t+=".mp3";let n=new e.AudioListener;camera.add(n),x.sound=new e.Audio(n);let o=new e.AudioLoader;o.load("aud/"+t,function(e){x.sound.setBuffer(e),x.sound.setLoop(!0),x.sound.setVolume(.9),x.sound.play(),cL(ui.onAud,0,"noneIt2"),cL(ui.offAud,1,"noneIt2")})}}
	